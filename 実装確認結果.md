# link.profilecode.codes 実装確認結果

## 📋 確認日時
- 確認日: 2024年（コードレビュー実施）
- 確認者: コードベース分析

## ✅ 確認結果サマリー
- [ ] すべての項目が合格
- [x] 一部の項目で問題あり（詳細を以下に記載）

---

## 1. 基本URL処理

### Q1-1: `/join` パスが正しく処理されているか？

**現在の実装状況**:
- ✅ `https://link.profilecode.codes/join` にアクセス可能（`index.html`が処理）
- ✅ `https://link.profilecode.codes/join?token=test123` にアクセス可能
- ✅ 404エラーにならない（`_config.yml`で`redirect_from: /join`が設定されている）

**実装詳細**:
```33:33:index.html
                if (path === "/join" && token) {
```

**評価**: ✅ **合格** - `/join`パスは正しく処理されている

---

### Q1-2: クエリパラメータ `token` が正しく取得できるか？

**現在の実装状況**:
- ✅ URLから `token` パラメータを取得可能
- ⚠️ `token` が存在しない場合、Android/iOS共にストアにリダイレクトされる

**実装詳細**:
```25:26:index.html
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get("token");
```

**評価**: ✅ **合格** - `token`パラメータは正しく取得できるが、存在しない場合の処理はストアリダイレクトのみ

---

### Q1-3: `/join` 以外のパスはどう処理されているか？

**現在の実装状況**:
- ❌ `/join/anything` のようなサブパスは処理されない
- ✅ `/join` で始まらないパス（例: `/other`）は404または`index.html`にフォールバック

**実装詳細**:
```33:33:index.html
                if (path === "/join" && token) {
```

**問題点**: 
- アプリ側の要件では `uri.path.startsWith('/join')` が必要だが、現在の実装は `path === "/join"` の厳密一致のみ
- `/join/anything` のようなサブパスは処理されない

**評価**: ❌ **不合格** - `/join`で始まるサブパスが処理されない

---

## 2. iOS Universal Links設定

### Q2-1: `apple-app-site-association` ファイルが正しく配置されているか？

**現在の実装状況**:
- ✅ `.well-known/apple-app-site-association` ファイルが存在
- ✅ `_config.yml`で`.well-known`ディレクトリが含まれている

**実装詳細**:
```1:2:_config.yml
include:
  - .well-known
```

**評価**: ✅ **合格** - ファイルは正しく配置されている（実際のHTTPアクセス確認は必要）

---

### Q2-2: `apple-app-site-association` ファイルの内容が正しいか？

**現在の実装状況**:
- ✅ `appID` が `J4SJR8W4AS.com.profilecode.profilecode` になっている
- ❌ `paths` が `["*"]` になっており、要件の `["/join*", "/auth/callback*", "/reset-password*", "/login-callback*"]` と異なる

**実装詳細**:
```1:11:.well-known/apple-app-site-association
{
    "applinks": {
        "apps": [],
        "details": [
            {
                "appID": "J4SJR8W4AS.com.profilecode.profilecode",
                "paths": ["*"]
            }
        ]
    }
}
```

**問題点**: 
- `paths` が `["*"]` で全パスを許可しているが、要件では特定のパスのみを許可すべき
- セキュリティ上の懸念がある可能性

**評価**: ⚠️ **要修正** - `appID`は正しいが、`paths`が要件と異なる

---

### Q2-3: `apple-app-site-association` ファイルのContent-Typeは正しいか？

**現在の実装状況**:
- ❓ 静的ファイルとして配置されているため、サーバー設定に依存
- GitHub Pagesを使用している場合、通常は `application/json` または `text/plain` で配信される可能性がある

**評価**: ❓ **要確認** - 実際のHTTPレスポンスヘッダーで確認が必要

---

### Q2-4: `apple-app-site-association` ファイルはリダイレクトされていないか？

**現在の実装状況**:
- ✅ `index.html`で特別処理によりリダイレクトを回避している

**実装詳細**:
```15:18:index.html
            // apple-app-site-associationファイルへのアクセスは特別処理をスキップ
            if (path === '/.well-known/apple-app-site-association') {
                return;
            }
```

**評価**: ✅ **合格** - リダイレクトされないように実装されている（実際のHTTPアクセス確認は必要）

---

## 3. Android App Links設定

### Q3-1: `assetlinks.json` ファイルが配置されているか？

**現在の実装状況**:
- ✅ `.well-known/assetlinks.json` ファイルが存在
- ✅ `_config.yml`で`.well-known`ディレクトリが含まれている

**実装詳細**:
```1:13:.well-known/assetlinks.json
[
    {
        "relation": ["delegate_permission/common.handle_all_urls"],
        "target": {
            "namespace": "android_app",
            "package_name": "com.profilecode.profilecode",
            "sha256_cert_fingerprints": [
                "84:B3:02:3D:37:4E:47:0C:9E:12:60:95:08:DD:F5:AD:3E:C0:A8:D4:DF:FA:FC:E6:50:A3:8E:9D:53:F6:9F:B8",
                "13:D9:4C:56:D9:9E:75:E3:FD:B6:67:1E:06:97:7C:81:11:EC:86:93:90:A1:16:A8:4F:EA:C9:61:15:18:08:0E"
            ]
        }
    }
]
```

**評価**: ✅ **合格** - ファイルは正しく配置されている（実際のHTTPアクセス確認は必要）

---

## 4. フォールバック処理

### Q4-1: アプリ未インストール時の処理はどうなっているか？

**現在の実装状況**:
- ✅ Android: Intentスキームでアプリ起動を試み、失敗時はPlay Storeにリダイレクト
- ✅ iOS: Universal Links → カスタムスキーム → App Storeの順でフォールバック

**実装詳細**:
```32:39:index.html
            if (isAndroid) {
                if (path === "/join" && token) {
                    // Sharelinkの場合
                    window.location.href = `intent://join?token=${token}#Intent;scheme=https;package=com.profilecode.profilecode;S.browser_fallback_url=${encodeURIComponent(playStoreLink)};end`;
                } else {
                    // その他の場合、直接Play Storeに遷移
                    window.location.href = playStoreLink;
                }
```

```40:63:index.html
            } else if (isIOS) {
                // iOSの場合、Universal LinksとカスタムURLスキームの両方を試す
                if (path === "/join" && token) {
                    // Sharelinkの場合
                    const universalLink = `https://link.profilecode.codes/join?token=${token}`;
                    const customScheme = `profilecode://join?token=${token}`;
                    
                    // まずUniversal Linksを試す
                    window.location.href = universalLink;
                    
                    // 3秒後にアプリが起動していなければカスタムURLスキームを試す
                    setTimeout(function() {
                        window.location.href = customScheme;
                        
                        // さらに3秒後にアプリが起動していなければApp Storeに遷移
                        setTimeout(function() {
                            window.location.href = appStoreLink;
                        }, 3000);
                    }, 3000);

                } else {
                    // その他の場合、直接App Storeに遷移
                    window.location.href = appStoreLink;
                }
```

**評価**: ✅ **合格** - フォールバック処理は実装されている

---

### Q4-2: カスタムスキームへのフォールバックは実装されているか？

**現在の実装状況**:
- ⚠️ iOSでカスタムスキームが `profilecode://join?token=${token}` になっている
- ❌ 要件では `com.profilecode.profilecode://join?token=TOKEN` が必要

**実装詳細**:
```45:45:index.html
                    const customScheme = `profilecode://join?token=${token}`;
```

**問題点**: 
- カスタムスキームが `profilecode://` になっているが、要件では `com.profilecode.profilecode://` が必要

**評価**: ❌ **不合格** - カスタムスキームが要件と異なる

---

## 5. セキュリティ・HTTPS

### Q5-1: HTTPSでアクセスできるか？

**現在の実装状況**:
- ✅ GitHub Pagesを使用している場合、HTTPSは自動的に有効
- ❓ 実際のSSL証明書の有効性は要確認

**評価**: ❓ **要確認** - 実際のHTTPアクセスで確認が必要

---

### Q5-2: HTTPからHTTPSへのリダイレクトは実装されているか？

**現在の実装状況**:
- ❓ GitHub Pagesの設定に依存（通常は自動的にリダイレクトされる）
- ❓ カスタムドメイン設定により異なる可能性がある

**評価**: ❓ **要確認** - 実際のHTTPアクセスで確認が必要

---

## 6. パフォーマンス・可用性

### Q6-1: レスポンス時間は適切か？

**現在の実装状況**:
- ✅ 静的HTMLファイルのため、通常は高速
- ⚠️ iOSのフォールバック処理でタイムアウトが6秒（3秒 + 3秒）設定されている

**実装詳細**:
```50:58:index.html
                    // 3秒後にアプリが起動していなければカスタムURLスキームを試す
                    setTimeout(function() {
                        window.location.href = customScheme;
                        
                        // さらに3秒後にアプリが起動していなければApp Storeに遷移
                        setTimeout(function() {
                            window.location.href = appStoreLink;
                        }, 3000);
                    }, 3000);
```

**評価**: ❓ **要確認** - 実際のHTTPアクセスで確認が必要（静的ファイルのため通常は高速）

---

### Q6-2: エラーハンドリングは適切か？

**現在の実装状況**:
- ⚠️ `token` が存在しない場合、ストアにリダイレクトされる
- ⚠️ 無効な `token` の場合の特別な処理はない（アプリ側で処理される想定）

**実装詳細**:
```33:38:index.html
                if (path === "/join" && token) {
                    // Sharelinkの場合
                    window.location.href = `intent://join?token=${token}#Intent;scheme=https;package=com.profilecode.profilecode;S.browser_fallback_url=${encodeURIComponent(playStoreLink)};end`;
                } else {
                    // その他の場合、直接Play Storeに遷移
                    window.location.href = playStoreLink;
                }
```

**評価**: ⚠️ **要検討** - `token`なしの場合はストアにリダイレクトされるが、エラーメッセージは表示されない

---

## 📝 問題点・改善点サマリー

### 重大な問題

1. **❌ Q1-3: `/join`で始まるサブパスが処理されない**
   - 現在: `path === "/join"` の厳密一致のみ
   - 要件: `path.startsWith("/join")` が必要
   - 影響: `/join/anything` のようなパスが処理されない

2. **❌ Q4-2: カスタムスキームが要件と異なる**
   - 現在: `profilecode://join?token=${token}`
   - 要件: `com.profilecode.profilecode://join?token=TOKEN`
   - 影響: アプリ側でカスタムスキームが処理されない可能性

3. **⚠️ Q2-2: `apple-app-site-association`の`paths`が要件と異なる**
   - 現在: `["*"]`（全パスを許可）
   - 要件: `["/join*", "/auth/callback*", "/reset-password*", "/login-callback*"]`
   - 影響: セキュリティ上の懸念、意図しないパスでもアプリが起動する可能性

### 要確認項目

4. **❓ Q2-3, Q2-4, Q5-1, Q5-2, Q6-1: 実際のHTTPアクセスでの確認が必要**
   - `apple-app-site-association`のContent-Type
   - HTTPS/SSL証明書の有効性
   - HTTP→HTTPSリダイレクト
   - レスポンス時間

### 改善提案

5. **⚠️ Q6-2: エラーハンドリングの改善**
   - `token`が存在しない場合のエラーメッセージ表示を検討

---

## 🔧 推奨される修正

### 優先度: 高

1. **`index.html`のパス処理を修正**
   ```javascript
   // 現在
   if (path === "/join" && token) {
   
   // 修正後
   if (path.startsWith("/join") && token) {
   ```

2. **iOSのカスタムスキームを修正**
   ```javascript
   // 現在
   const customScheme = `profilecode://join?token=${token}`;
   
   // 修正後
   const customScheme = `com.profilecode.profilecode://join?token=${token}`;
   ```

3. **`apple-app-site-association`の`paths`を修正**
   ```json
   // 現在
   "paths": ["*"]
   
   // 修正後
   "paths": [
       "/join*",
       "/auth/callback*",
       "/reset-password*",
       "/login-callback*"
   ]
   ```

---

## 📊 確認結果まとめ

| カテゴリ | 合格 | 要修正 | 要確認 | 合計 |
|---------|------|--------|--------|------|
| 基本URL処理 | 2 | 1 | 0 | 3 |
| iOS Universal Links | 2 | 1 | 2 | 5 |
| Android App Links | 1 | 0 | 0 | 1 |
| フォールバック処理 | 1 | 1 | 0 | 2 |
| セキュリティ・HTTPS | 0 | 0 | 2 | 2 |
| パフォーマンス・可用性 | 0 | 0 | 2 | 2 |
| **合計** | **6** | **3** | **6** | **15** |

**総合評価**: ⚠️ **一部の項目で問題あり** - 3つの重大な問題と6つの要確認項目がある

